<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - SecureNet</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Device Fingerprinting Library -->
    <script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3/dist/fp.min.js"></script>
</head>
<body class="auth-page">
    <!-- Navigation -->
    <nav class="navbar navbar-auth">
        <div class="container">
            <a href="index.html" class="nav-brand">
                <i class="fas fa-shield-alt"></i>
                <span>SecureNet</span>
            </a>
        </div>
    </nav>

    <!-- Login Section -->
    <section class="auth-section">
        <div class="auth-container">
            <div class="auth-card">
                <div class="auth-header">
                    <h1>Welcome Back</h1>
                    <p>Your typing pattern is being analyzed for security</p>
                </div>

                <!-- Security Status -->
                <div class="security-status">
                    <div class="status-item">
                        <i class="fas fa-keyboard"></i>
                        <span>Keystroke Analysis: <strong id="keystrokeStatus">Active</strong></span>
                    </div>
                    <div class="status-item">
                        <i class="fas fa-network-wired"></i>
                        <span>Device ID: <strong id="deviceStatus">Detecting...</strong></span>
                    </div>
                    <div class="status-item">
                        <i class="fas fa-brain"></i>
                        <span>ML Model: <strong id="mlStatus">Ready</strong></span>
                    </div>
                </div>

                <!-- Login Form -->
                <form id="loginForm" class="auth-form">
                    <div class="form-group">
                        <label for="username">
                            <i class="fas fa-user"></i> Username
                        </label>
                        <input 
                            type="text" 
                            id="username" 
                            name="username" 
                            required 
                            placeholder="Enter your username"
                            autocomplete="username"
                        >
                    </div>

                    <div class="form-group">
                        <label for="password">
                            <i class="fas fa-lock"></i> Password
                        </label>
                        <input 
                            type="password" 
                            id="password" 
                            name="password" 
                            required 
                            placeholder="Enter your password"
                            autocomplete="current-password"
                        >
                        <small class="form-hint">
                            <i class="fas fa-info-circle"></i> Type naturally - we're analyzing your unique pattern
                        </small>
                    </div>

                    <button type="submit" class="btn btn-primary btn-block" id="loginButton">
                        <i class="fas fa-sign-in-alt"></i> Login Securely
                    </button>
                </form>

                <div class="form-footer">
                    <a href="#" class="link">Forgot password?</a>
                </div>

                <!-- Security Analysis (shown after login attempt) -->
                <div id="securityAnalysis" class="security-analysis" style="display: none;">
                    <h3>Security Analysis</h3>
                    
                    <div class="analysis-row">
                        <span>Risk Level:</span>
                        <strong id="riskLevel">-</strong>
                    </div>
                    
                    <div class="analysis-row">
                        <span>ML Prediction:</span>
                        <strong id="mlPrediction">-</strong>
                    </div>
                    
                    <div class="analysis-row">
                        <span>Behavioral Match:</span>
                        <strong id="behavioralMatch">-</strong>
                    </div>
                    
                    <div class="analysis-row">
                        <span>EDNS Status:</span>
                        <strong id="ednsResult">-</strong>
                    </div>
                </div>

               <div class="footer-card" style="
                    margin-top: 28px;
                    padding: 16px 18px;
                    border-radius: 14px;
                    background: #f9fafb;
                    border: 1px solid #e5e7eb;
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    gap: 16px;
                ">
                  <div style="display:flex; flex-direction:column;">
                    <span style="font-size:13px; color:#6b7280;">New to SecureNet?</span>
                    <a href="register.html" style="font-size:14px; font-weight:600; color:#4f46e5; text-decoration:none; margin-top:2px;">
                      Create a student demo account ‚Üí
                    </a>
                  </div>
                  <div style="height:32px; width:1px; background:#e5e7eb;"></div>
                  <a href="admin-login.html" style="
                      display:flex;
                      align-items:center;
                      gap:6px;
                      font-size:13px;
                      font-weight:500;
                      color:#111827;
                      text-decoration:none;
                      padding:8px 10px;
                      border-radius:999px;
                      background:#eef2ff;
                  ">
                    <i class="fas fa-shield-alt" style="color:#4f46e5;"></i>
                    <span>Admin access</span>
                  </a>
                </div>      
            </div>

            <!-- Security Info Sidebar -->
            <div class="security-info">
                <h3><i class="fas fa-shield-check"></i> Multi-Layer Security</h3>
                
                <div class="info-item">
                    <div class="info-icon">
                        <i class="fas fa-fingerprint"></i>
                    </div>
                    <div class="info-content">
                        <h4>Behavioral Biometrics</h4>
                        <p>Your unique typing pattern is analyzed in real-time</p>
                    </div>
                </div>
                
                <div class="info-item">
                    <div class="info-icon">
                        <i class="fas fa-network-wired"></i>
                    </div>
                    <div class="info-content">
                        <h4>Device Fingerprinting</h4>
                        <p>Each device is uniquely identified for security</p>
                    </div>
                </div>
                
                <div class="info-item">
                    <div class="info-icon">
                        <i class="fas fa-brain"></i>
                    </div>
                    <div class="info-content">
                        <h4>AI Detection</h4>
                        <p>98.82% accurate ML model validates each login</p>
                    </div>
                </div>
            </div>         
        </div>
    </section>

    <!-- Generic Auth Modal -->
    <div id="authModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5);
        z-index:9999; align-items:center; justify-content:center;">
      <div style="background:white; padding:32px 32px 28px; border-radius:16px; max-width:420px; text-align:center;">
        <i class="fas fa-shield-alt" style="font-size:40px; color:#667eea; margin-bottom:18px;"></i>
        <h3 id="authModalTitle" style="margin-bottom:12px; font-size:22px;">Security Check</h3>
        <p id="authModalMessage" style="color:#6b7280; margin:0 0 20px; line-height:1.5;">
          Message goes here.
        </p>
        <div id="authModalInputRow" style="display:none; margin-bottom:16px;">
          <input id="authModalInput" type="text"
                 style="width:100%; padding:10px 12px; border-radius:10px; border:1px solid #e5e7eb; font-size:14px;"
                 placeholder="">
        </div>
        <div style="display:flex; flex-direction:column; gap:10px;">
          <button id="authModalPrimaryBtn" class="btn btn-primary" style="padding:10px 18px;">
            OK
          </button>
          <button id="authModalSecondaryBtn" class="btn" style="background:#e5e7eb; color:#374151; padding:10px 18px;">
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="js/keystroke.js"></script>
    <script src="js/auth.js"></script>
    <script>
        // Initialize device fingerprint on page load
        let deviceFingerprint = null;

        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize device fingerprinting
            try {
                const fp = await FingerprintJS.load();
                const result = await fp.get();
                deviceFingerprint = result.visitorId;
                document.getElementById('deviceStatus').textContent = deviceFingerprint.substring(0, 8) + '...';
                console.log('üîç Device fingerprint:', deviceFingerprint);
            } catch (error) {
                console.error('Fingerprint error:', error);
                deviceFingerprint = 'unknown';
                document.getElementById('deviceStatus').textContent = 'Unknown';
            }

            // Initialize keystroke capture
            const passwordInput = document.getElementById('password');
            
            passwordInput.addEventListener('focus', function() {
                resetKeystrokeCapture();
                initKeystrokeCapture(passwordInput);
            });
            
            initKeystrokeCapture(passwordInput);
            
            // Handle login form submission
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
        });

        // Handle login with adaptive MFA
        async function handleLogin(e) {
            e.preventDefault();
            
            const loginButton = document.getElementById('loginButton');
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // Validate inputs
            if (!username || !password) {
                openAuthModal({
                    title: 'Missing Information',
                    message: 'Please enter both username and password.',
                    primaryText: 'OK',
                    secondaryText: 'Close',
                    onPrimary: closeAuthModal
                });
                return;
            }
            
            // Get keystroke data
            const keystrokeData = getKeystrokeTimings();
            console.log('Login attempt - Keystroke count:', keystrokeData.length);
            
            // Disable button
            loginButton.disabled = true;
            loginButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Authenticating...';
            
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password,
                        keystroke_timings: keystrokeData,
                        network_info: await getNetworkInfo()
                    })
                });
                
                const result = await response.json();
                
                // Show security analysis
                if (result.security_analysis) {
                    displaySecurityAnalysis(result.security_analysis);
                }
                
                // Handle different response types
                if (result.success) {
                    // SUCCESS: Direct login (Low Risk)
                    localStorage.setItem('auth_token', result.token);
                    localStorage.setItem('user', JSON.stringify(result.user));
                    showNotification('‚úÖ Login successful!', 'success');
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 500);

                } else if (result.action === 'BLOCK') {
                    // Hard BLOCK from backend
                    const msg = result.message || result.error ||
                        'Your login was blocked due to high risk. Please contact support.';
                    showNotification('üö´ ' + msg, 'error');
                    openAuthModal({
                        title: 'Login Blocked',
                        message: msg,
                        primaryText: 'OK',
                        secondaryText: 'Close',
                        onPrimary: closeAuthModal
                    });
                    resetKeystrokeCapture();
                    document.getElementById('password').value = '';
                    document.getElementById('password').focus();

                } else if (result.mfa_required) {
                    // MFA REQUIRED
                    if (result.mfa_type === 'email') {
                        // Medium Risk: Email OTP
                        showNotification(result.message, 'info');
                        promptEmailOTP(username, result.message);
                        
                    } else if (result.mfa_type === 'totp') {
                        // High Risk: TOTP (Authenticator App)
                        if (result.mfa_setup_required) {
                            // Treat as blocked until admin/support configures MFA
                            const msg = result.error ||
                                'Your account requires authenticator setup due to high risk. Please contact support to enable MFA.';
                            showNotification('üö´ ' + msg, 'error');
                            openAuthModal({
                                title: 'Login Blocked',
                                message: msg,
                                primaryText: 'OK',
                                secondaryText: 'Close',
                                onPrimary: closeAuthModal
                            });
                            resetKeystrokeCapture();
                            document.getElementById('password').value = '';
                            document.getElementById('password').focus();
                        } else {
                            // User already has TOTP - redirect to verification
                            localStorage.setItem('mfa_pending', JSON.stringify({
                                username: username,
                                type: 'totp',
                                timestamp: Date.now()
                            }));
                            window.location.href = 'mfa-verify.html';
                        }
                    }
                    
                } else {
                    // WRONG PASSWORD or other non-block error
                    if (result.error) {
                        const err = result.error.toLowerCase();
                        if (err.includes('locked')) {
                            showNotification('üö´ Account blocked: ' + result.error, 'error');
                            openAuthModal({
                                title: 'Account Locked',
                                message: 'Your account is locked due to multiple failed login attempts. Please contact support.',
                                primaryText: 'OK',
                                secondaryText: 'Close',
                                onPrimary: closeAuthModal
                            });
                        } else if (err.includes('invalid credentials')) {
                            showNotification('‚ùå Wrong password or username.', 'error');
                            openAuthModal({
                                title: 'Login Failed',
                                message: 'Wrong username or password. Please try again.',
                                primaryText: 'OK',
                                secondaryText: 'Close',
                                onPrimary: () => {
                                    closeAuthModal();
                                    document.getElementById('password').focus();
                                }
                            });
                            const passInput = document.getElementById('password');
                            passInput.classList.add('input-error');
                            setTimeout(() => passInput.classList.remove('input-error'), 400);
                        } else {
                            showNotification('‚ùå ' + result.error, 'error');
                            openAuthModal({
                                title: 'Login Error',
                                message: result.error,
                                primaryText: 'OK',
                                secondaryText: 'Close',
                                onPrimary: closeAuthModal
                            });
                        }
                    } else {
                        showNotification('‚ùå Login failed', 'error');
                        openAuthModal({
                            title: 'Login Failed',
                            message: 'Login failed. Please try again.',
                            primaryText: 'OK',
                            secondaryText: 'Close',
                            onPrimary: closeAuthModal
                        });
                    }
                    resetKeystrokeCapture();
                    document.getElementById('password').value = '';
                    document.getElementById('password').focus();
                }

            } catch (error) {
                console.error('Login error:', error);
                showNotification('Connection error. Please check if the server is running.', 'error');
                openAuthModal({
                    title: 'Connection Error',
                    message: 'Unable to reach the server. Please check your connection and try again.',
                    primaryText: 'OK',
                    secondaryText: 'Close',
                    onPrimary: closeAuthModal
                });
                resetKeystrokeCapture();
            } finally {
                loginButton.disabled = false;
                loginButton.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login Securely';
            }
        }

        // Enhanced network info with device fingerprinting
        async function getNetworkInfo() {
            try {
                return {
                    user_agent: navigator.userAgent,
                    device_fingerprint: deviceFingerprint || 'unknown',
                    screen_resolution: `${screen.width}x${screen.height}`,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    language: navigator.language,
                    platform: navigator.platform,
                    hardware_concurrency: navigator.hardwareConcurrency,
                    device_memory: navigator.deviceMemory || 'unknown',
                    color_depth: screen.colorDepth
                };
            } catch (error) {
                console.error('Network info error:', error);
                return {
                    user_agent: navigator.userAgent,
                    device_fingerprint: deviceFingerprint || 'unknown'
                };
            }
        }

        // Prompt for Email OTP (Medium Risk) using modal
        function promptEmailOTP(username, message) {
            openAuthModal({
                title: 'Email Verification',
                message: message,
                primaryText: 'Verify',
                secondaryText: 'Cancel',
                showInput: true,
                inputType: 'text',
                inputPlaceholder: 'Enter 6-digit code',
                onPrimary: (value) => {
                    const code = (value || '').trim();
                    if (code.length !== 6 || !/^\d+$/.test(code)) {
                        showNotification('Invalid code format. Please enter a 6-digit number.', 'error');
                        return;
                    }
                    closeAuthModal();
                    verifyEmailOTP(username, code);
                },
                onSecondary: () => {
                    showNotification('Verification cancelled', 'warning');
                }
            });
        }

        // Verify Email OTP
        async function verifyEmailOTP(username, code) {
            const loginButton = document.getElementById('loginButton');
            loginButton.disabled = true;
            loginButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';
            
            try {
                const response = await fetch('/api/mfa/verify-email-otp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, code })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    localStorage.setItem('auth_token', result.token);
                    localStorage.setItem('user', JSON.stringify(result.user));
                    showNotification('‚úÖ ' + result.message, 'success');
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 1000);
                } else {
                    showNotification('‚ùå ' + result.error, 'error');
                    openAuthModal({
                        title: 'Verification Failed',
                        message: result.error + '\n\nTry again with the correct code.',
                        primaryText: 'Try Again',
                        secondaryText: 'Cancel',
                        onPrimary: () => {
                            closeAuthModal();
                            promptEmailOTP(username, 'Enter the verification code from your email');
                        },
                        onSecondary: () => {
                            closeAuthModal();
                            showNotification('Verification cancelled', 'warning');
                        }
                    });
                }
            } catch (error) {
                console.error('Email OTP verify error:', error);
                showNotification('Connection error. Please try again.', 'error');
                openAuthModal({
                    title: 'Connection Error',
                    message: 'Unable to verify the code due to a connection issue. Please try again.',
                    primaryText: 'OK',
                    secondaryText: 'Close',
                    onPrimary: closeAuthModal
                });
            } finally {
                loginButton.disabled = false;
                loginButton.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login Securely';
            }
        }

        // Display security analysis
        function displaySecurityAnalysis(analysis) {
            document.getElementById('securityAnalysis').style.display = 'block';
            
            const riskLevel = analysis.final_risk_level || 'N/A';
            document.getElementById('riskLevel').textContent = riskLevel;
            document.getElementById('mlPrediction').textContent = analysis.ml_prediction || 'N/A';
            document.getElementById('behavioralMatch').textContent = analysis.keystroke_deviation || 'N/A';
            document.getElementById('ednsResult').textContent = 
                analysis.edns_security?.threat_detected ? '‚ö†Ô∏è Threat Detected' : '‚úì Safe';
            
            const riskElem = document.getElementById('riskLevel');
            if (riskLevel.includes('High') || riskLevel.includes('Critical')) {
                riskElem.style.color = '#ef4444';
            } else if (riskLevel.includes('Medium')) {
                riskElem.style.color = '#f59e0b';
            } else {
                riskElem.style.color = '#10b981';
            }
        }

        // Show notification (simple version)
        function showNotification(message, type) {
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // Modal helpers
        function openAuthModal(options) {
            const {
                title,
                message,
                primaryText = 'OK',
                secondaryText = 'Close',
                showInput = false,
                inputType = 'text',
                inputPlaceholder = '',
                onPrimary,
                onSecondary
            } = options;

            const modal = document.getElementById('authModal');
            document.getElementById('authModalTitle').textContent = title;
            document.getElementById('authModalMessage').textContent = message;

            const primaryBtn = document.getElementById('authModalPrimaryBtn');
            const secondaryBtn = document.getElementById('authModalSecondaryBtn');
            primaryBtn.textContent = primaryText;
            secondaryBtn.textContent = secondaryText;

            const inputRow = document.getElementById('authModalInputRow');
            const inputEl = document.getElementById('authModalInput');
            if (showInput) {
                inputRow.style.display = 'block';
                inputEl.type = inputType;
                inputEl.value = '';
                inputEl.placeholder = inputPlaceholder;
            } else {
                inputRow.style.display = 'none';
                inputEl.value = '';
            }

            primaryBtn.onclick = () => {
                if (onPrimary) onPrimary(inputEl.value);
            };
            secondaryBtn.onclick = () => {
                if (onSecondary) onSecondary();
                closeAuthModal();
            };

            modal.style.display = 'flex';
        }

        function closeAuthModal() {
            document.getElementById('authModal').style.display = 'none';
        }
    </script>
</body>
</html>
